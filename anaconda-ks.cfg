# Kickstart file automatically generated by anaconda.

#version=RHEL6

# Installation parameters
install
cdrom

repo --name="Scientific Linux Local" --baseurl="nfs://mocndt.lan:/Volumes/Data/Shared Items/repos/scientific/6/x86_64/os/" --cost=10
repo --name="Cyber Linux Security" --baseurl="nfs://mocndt.lan:/Volumes/Data/Shared Items/repos/scientific/6/x86_64/updates/security/" --cost=10
repo --name="Extra Packages for Enterprise Linux 6" --baseurl="http://serverbeach1.fedoraproject.org/pub/epel/6/x86_64/" --cost=50

#interactive
#autostep --autoscreenshot
network 

# Base system configuration
lang en_US.UTF-8
keyboard us
timezone --utc America/Chicago

# Authentication

# (V-22303) Use FIPS 140-2 validated hashing algorithms
authconfig --enableshadow --passalgo=sha512 
rootpw --iscrypted $1$Yy5m70$7bWqOzhGTwQGri5d83pjc.

user --name=ladmin --groups=wheel --password=$1$fDI8vU2s$KFypGY3B2wbN27xfEn6Zg1 --iscrypted 

# Networking and Security
firewall --enabled --ssh 

# DISA STIG (V-22584)
selinux --enforcing

# Filesystem / disks
clearpart --all --initlabel
autopart --encrypted --passphrase=havN0clu3
bootloader --location=partition --driveorder=sdb --append="crashkernel=auto rhgb quiet" --md5pass=$1$sIsG0Li1$aQhnq0c.Wsx9LKVYDETCg.

# The following is the partition information you requested
# Note that any partitions you deleted are not expressed
# here so unless you clear all partitions first, this is
# not guaranteed to work
#clearpart --linux --drives=sdb
#part  --grow --size=1 pv.RpjNp1-vYlc-PKtA-rEkd-zkfB-2G9k-J50sIb
#part /boot --fstype=ext4 --size=500
#part  --grow --size=1 --ondisk=sdb --noformat
#volgroup vg_ngmocnd3500lx --pesize=4096 pv.RpjNp1-vYlc-PKtA-rEkd-zkfB-2G9k-J50sIb
#logvol /home --fstype=ext4 --name=lv_home --vgname=vg_ngmocnd3500lx --grow --size=100
#logvol / --fstype=ext4 --name=lv_root --vgname=vg_ngmocnd3500lx --grow --size=1024 --maxsize=51200
#logvol swap --name=lv_swap --vgname=vg_ngmocnd3500lx --grow --size=1024 --maxsize=9984

%post --log=/root/ks-post.log
#!/bin/bash

EXTDIR="/usr/lib64/firefox-3.6/extensions"
EXTFILE="dod_configuration-1.3.xpi"
TMPDIR="/tmp/ext"

########## Install DoD extension for CAC on Firefox ########
echo
echo "##################################################"
echo "#   Downloading/Installing DoD Firefox Config    #"
echo "##################################################"


/usr/bin/wget http://www.forge.mil/downloads/plugins/mozilla/dod_configuration-1.3.xpi -O /tmp/${EXTFILE} &2>1 

umask 0022
mkdir -p "${TMPDIR}"
unzip "/tmp/${EXTFILE}" -d "${TMPDIR}" &> /dev/null

FILE="`cat "$TMPDIR/install.rdf"`"; GET=; ID=
for i in $FILE; do
	if echo "$i" | grep "urn:mozilla:install-manifest" > /dev/null; then
		GET=true
		continue
	fi
	if [ "$GET" = true ]; then
		if echo "$i" | grep "<em:id>" > /dev/null; then ID=`echo "$i" | sed 's#.*<em:id>\(.*\)</em:id>.*#\1#'`
		elif echo "$i" | grep "em:id=\"" > /dev/null; then ID=`echo "$i" | sed 's/.*em:id="\(.*\)".*/\1/'`; fi

		[ -n "$ID" ] && break
	fi
done

mv "$TMPDIR" "$EXTDIR/$ID"

rm -rf "/tmp/${EXTFILE}"
rm -rf "${TMPDIR}"

echo "########## Beginning STIG Lockdown ################"
######## DISA STIG #############
# (V-1021)

cat >> /etc/gdm/custom.conf << EOF
[server-Standard]
name=Standard server
command=/usr/bin/Xorg -br -audit 4 -s 15
chooser=false
handled=true
flexible=true
priority=0
EOF

# (V-1055)
chmod 0640 /etc/security/access.conf

# (V-4336)
chmod 0600 /etc/sysctl.conf

# TODO (V-4346) - pam_console.so

# TODO (V-22598) - boot auditing

echo "######### Configuring Time Synchronization ############"

# (V-4301) - Network Time Server synch
sed -i 's/^server/\#server/g' /etc/ntp.conf

cat >> /etc/ntp.conf << EOF
# DISA STIG (V-4301) - USG/DoD Time Servers
server tick.usnogps.navy.mil 
server tock.usno.navy.mil 
server time.nist.gov

EOF

# (V-22290) Sync time at least daily
# (V-22291) With 2 or more servers
# TODO (V-22293) Use key or autokey ntp authentication
cat > /etc/cron.d/ntpd << EOF
# DISA STIG (V-22290 & V-22291)
15 * * * * root /usr/sbin/ntpd -q -u ntp:ntp
EOF

# Shutdown service since we're using cron
service ntpd stop
chkconfig ntpd off

# (V-26297) /etc/ntp.conf must be 0640 or less
chmod 0640 /etc/ntp.conf

echo "############ Removing Unneeded Accounts ##########"

# (V-4268)
sed -i '/^shutdown/d' /etc/passwd /etc/shadow
sed -i '/^halt/d' /etc/passwd /etc/shadow
sed -i '/^reboot/d' /etc/passwd /etc/shadow


# (V-4269-1) - Remove 'games' account
sed -i "/^games/d" /etc/passwd

# (V-4269-2) - Remove 'news' account
sed -i "/^news/d" /etc/passwd

# (V-4269-3) - Remove 'gopher' account
sed -i "/^gopher/d" /etc/passwd

# (V-4269-4) - Remove 'ftp' account
sed -i "/^ftp/d" /etc/passwd

# (V-4269-5) - Remove 'lp' account
sed -i "/^lp/d" /etc/passwd

echo "############# Configuring Login Restrictions ###################"

# (V-763) - DoD Login Banner
cat > /etc/issue << EOF
You are accessing a U.S. Government (USG) Information System (IS) that is
provided for USG-authorized use only.

By using this IS (which includes any device attached to this IS), you consent to
the following conditions:

-The USG routinely intercepts and monitors communications on this IS for
purposes including, but not limited to, penetration testing, COMSEC monitoring,
network operations and defense, personnel misconduct (PM), law enforcement (LE),
and counterintelligence (CI) investigations.

-At any time, the USG may inspect and seize data stored on this IS.

-Communications using, or data stored on, this IS are not private, are subject
to routine monitoring, interception, and search, and may be disclosed or used
for any USG-authorized purpose.

-This IS includes security measures (e.g., authentication and access controls)
to protect USG interests--not for your personal benefit or privacy.

-Notwithstanding the above, using this IS does not constitute consent to PM, LE
or CI investigative searching or monitoring of the content of privileged
communications, or work product, related to personal representation or services
by attorneys, psychotherapists, or clergy, and their assistants. Such
communications and work product are private and confidential. See User Agreement
for details.

EOF

# Also do this for SSH
sed -i 's/\#Banner.*$/Banner \/etc\/issue' /etc/ssh/sshd_config

# (V-24331) - Graphical Login Banner
gconftool-2 --direct --config-source xml:readwrite:/etc/gconf/gconf.xml.mandatory --type bool \
 --set /apps/gdm/simple-greeter/banner_message_enable true
gconftool-2 --direct --config-source xml:readwrite:/etc/gconf/gconf.xml.mandatory --type string \
 --set /apps/gdm/simple-greeter/banner_message_text "You are accessing a U.S. Government (USG) Information System (IS) that is provided for USG-authorized use only.By using this IS (which includes any device attached to this IS), youconsent to the following conditions: -The USG routinely intercepts and monitors communications on this IS for purposes including, but not limited to, penetration testing,COMSEC monitoring, network operations and defense, personnel misconduct (PM),law enforcement (LE), and counterintelligence (CI) investigations. -At any time, the USG may inspect and seize data stored on this IS. -Communications using, or data stored on, this IS are not private,are subject to routine monitoring, interception, and search,and may be disclosed or used for any USG-authorized purpose. -This IS includes security measures (e.g., authenticationand access controls) to protect USG interests--notfor your personal benefit or privacy.-Notwithstanding the above, using this IS does notconstitute consent to PM, LE or CI investigative searching or monitoring of the content of privileged communications, or work product, relatedto personal representation or services by attorneys, psychotherapists,or clergy, and their assistants. Such communications and workproduct are private and confidential. See User Agreement for details."

# Not a requirement of this rule, but good anyway
gconftool-2 --direct --config-source xml:readwrite:/etc/gconf/gconf.xml.mandatory --type bool \
 --set /apps/gdm/simple-greeter/disable_user_list true


# (V-22298) - Maximum Logins per user
cat >> /etc/security/limits.d/maxlogins.conf << EOF
# DISA STIG (V-22298) Maximum Logins Per User
* hard maxlogins 10

EOF

# (V-22299) - Print Last Login Information
sed -i 's/^\#PrintLastLog/PrintLastLog/' /etc/ssh/sshd_config

# (V-22300) - Display unsuccessful login attempts
# (V-766) - Lockout accounts after 3 unsuccessful attempts

cat >> /etc/pam.d/system-auth-local << EOF
# DISA STIG (V-11948-2) - Local global system-auth file is used
# DISA STIG (V-22300) - Display Unsuccessful Login Attempts
auth        requisite     pam_access.so

# DISA STIG (V-766) - Lockout accounts after 3 unsuccessful attempts
# DISA STIG (V-768) - Delay of 4 seconds between login attempts
auth        requisite     pam_tally2.so deny=3 lock_time=4
account     required      pam_tally2.so
# DISA STIG (V-22307) Prevent dictionary passwords
# DISA STIG (V-11947) Password Length
# DISA STIG (V-11948-1) Complex Passwords
# DISA STIG (V-22305) Passwords contain at least one lowercase alpha
# DISA STIG (V-11972) Passwords contain at least one numeric
# DISA STIG (V-11973) Passwords contain at least one special
# DISA STIG (V-11975) No more than three consecutive repeating chars
# DISA STIG (V-22306) At least four chars change between passwords
password    required      pam_cracklib.so minlen=14 ucredit=-1 lcredit=-1 dcredit=-1 ocredit=-1 maxrepeat=3 difok=4
session     required      pam_lastlog.so showfailed

auth        include       system-auth-ac
account     include       system-auth-ac
password    include       system-auth-ac
session     include       system-auth-ac

EOF

ln -sf /etc/pam.d/system-auth-local /etc/pam.d/system-auth

# (V-4083-1) - Screensaver on idle
gconftool-2 --direct --config-source xml:readwrite:/etc/gconf/gconf.xml.mandatory --type bool --set /apps/gnome-screensaver/idle_activation_enabled true
# (V-4083-3) - Idle occurs <= 15 mins
gconftool-2 --direct --config-source xml:readwrite:/etc/gconf/gconf.xml.mandatory --type int --set /apps/gnome-screensaver/idle_delay 15
# (V-4083-3) - Lock on screensaver 
gconftool-2 --direct --config-source xml:readwrite:/etc/gconf/gconf.xml.mandatory --type bool --set /apps/gnome-screensaver/lock_enabled true

# (V-1032) Passwords can be changed more than once per 24 h
sed -i 's/^PASS_MIN_DAYS.*$/PASS_MIN_DAYS\t1/' /etc/login.defs

# (V-11976) Password change every 60 days
sed -i 's/^PASS_MAX_DAYS.*$/PASS_MAX_DAYS\t60/' /etc/login.defs

# (V-770) An account on the system is not password protected
sed -i 's/nullok //' /etc/pam.d/system-auth*

# (V-23825) - Use FIPS 140-2 validated cryptographic modules
# RHEL 6 includes FIPS validated OpenSSL modules, configure
# applications to use it

## SSH
cat >> /etc/ssh/sshd_config << EOF
# DISA STIG (V-23825) - FIPS 140-2 Validated Algorithms
Ciphers aes128-ctr,aes192-ctr,aes256-ctr
EOF

# (V-22308) - Restrict root access to wheel group
sed -i '6s/^\#//' /etc/pam.d/su

cat > /etc/sudoers.d/disa-stig-wheel << EOF
# Per DISA STIG (V-22308) - Restrict root access to wheel group
# Allow people in group wheel to run all commands
%wheel ALL=(ALL)	ALL

EOF

chmod 0440 /etc/sudoers.d/disa-stig-wheel

# (V-755) - Root home directory has restrictive permissions
chmod 0700 `grep "^root" /etc/passwd | cut -d: -f6` 

# (V-778) - Root can only directly login on console
echo console > /etc/securetty

# (V-1047) - Do not permit remote root login
sed -i 's/^#PermitRootLogin.*$/PermitRootLogin no/' /etc/ssh/sshd_config

# (V-825) - Disable console messaging
cat > /etc/profile.d/mesg-disable.sh << EOF
# DISA STIG (V-825) Disable console messaging
mesg n
EOF

chmod 644 /etc/profile.d/mesg-disable.sh

echo "################ Setting default umask ##############"

# (V-808) Default mask should be 077
cat > /etc/profile.d/stig-umask.sh << EOF
# DISA STIG (V-888)
umask 077
EOF

cat > /etc/profile.d/stig-umask.csh << EOF
# DISA STIG (V-888)
umask 077
EOF

echo "############## Configuring Auditing ##################"

# (V-815) - Audit file deletions
# (V-22376) - Audit account modification
cat >> /etc/audit/audit.rules << EOF
# DISA STIG (V-815)
-a always,exit -S unlink -S rmdir

# DISA STIG (V-22376)
-w /usr/sbin/useradd -p x -k useradd
-w /usr/sbin/groupadd -p x -k groupadd
-w /etc/passwd -p a -k passwd
-w /etc/shadow -p a -k shadow
-w /etc/group -p a -k group
-w /etc/gshadow -p a -k gshadow

# DISA STIG (V-22377)
-w /usr/sbin/usermod -p x -k usermod
-w /usr/sbin/groupmod -p x -k groupmod
-w /usr/sbin/usermod -p x -k usermod
-w /usr/sbin/groupmod -p x -k groupmod

# DISA STIG (V-22378)
-w /usr/sbin/passwd -p x -k passwd

# DISA STIG (V-22382)
-w /usr/sbin/userdel -p x -k userdel
-w /usr/sbin/groupdel -p x -k groupdel

# DISA STIG (V-816)
-w /etc/auditd.conf
-w /etc/audit/auditd.conf
-w /etc/audit.rules
-w /etc/audit/audit.rules
-a always,exit -F arch=b32 -S adjtimex -S settimeofday -S stime -k time-change
-a always,exit -F arch=b32 -S sethostname -S setdomainname -k system-locale
-a always,exit -F arch=b32 -S clock_settime -k time-change
-a always,exit -F arch=b32 -S sched_setparam -S sched_setscheduler

-a always,exit -F arch=b64 -S adjtimex -S settimeofday -S stime -k time-change
-a always,exit -F arch=b64 -S sethostname -S setdomainname -k system-locale
-a always,exit -F arch=b64 -S clock_settime -k time-change
-a always,exit -F arch=b64 -S sched_setparam -S sched_setscheduler

# DISA STIG (V-819)
-a always,exit -F arch=b32 -S chmod -S fchmod -S fchmodat -S chown -S fchown -k perm_mod
-a always,exit -F arch=b32 -S fchownat -S lchown -S setxattr -S lsetxattr -S fsetxattr -k perm_mod
-a always,exit -F arch=b32 -S removexattr -S lremovexattr -S fremovexattr -k perm_mod
-a always,exit -F arch=b32 -S chown32 -S fchown32 -S lchown32 -k perm_mod

-a always,exit -F arch=b64 -S chmod -S fchmod -S fchmodat -S chown -S fchown -k perm_mod
-a always,exit -F arch=b64 -S fchownat -S lchown -S setxattr -S lsetxattr -S fsetxattr -k perm_mod
-a always,exit -F arch=b64 -S removexattr -S lremovexattr -S fremovexattr -k perm_mod
-a always,exit -F arch=b64 -S chown32 -S fchown32 -S lchown32 -k perm_mod

# DISA STIG (V-22383)
-a always,exit -S init_module -S delete_module -k modules
-w /sbin/insmod -p x -k modules
-w /sbin/modprobe -p x -k modules
-w /sbin/rmmod -p x -k modules

EOF

# (V-4375) - Rotate audit logs daily
cat > /etc/logrotate.d/auditd << EOF

# DISA STIG (V-4357)
/var/log/audit/audit.log {
	daily
	missingok
	rotate 4
	compress
	delaycompress
	copytruncate
	minsize 100k
}

EOF

###### Relabel Filesystem SELinux Contexts ##########
echo "########## Relabelling SELinux Contexts ###########"
fixfiles relabel


##### RUN THIS LAST ############
# (V-11941-1) - System Baseline w/ hashes
sed -i "4s/PRELINKING=yes/PRELINKING=no/" /etc/sysconfig/prelink
/usr/sbin/prelink -ua

# (V-11945) - Daily Baseline check
cat > /etc/cron.d/aide << EOF
# DISA STIG (V-11945) Daily Baseline Check
05 04 * * * root /usr/sbin/aide --check
EOF

echo "############ Initializing Aide database #################"
/usr/sbin/aide --init


%end

%packages
@base
@core
@debugging
@basic-desktop
@compat-libraries
@console-internet

@desktop-debugging
@desktop-platform
@directory-client
@fonts
@general-desktop
@graphical-admin-tools
@input-methods
@internet-applications
@internet-browser
@java-platform
@legacy-x
@misc-sl
@mysql-client
@mysql
@network-file-system-client
@network-tools
@office-suite
@print-client
@remote-desktop-clients
@scalable-file-systems
@security-tools
@server-platform
@smart-card
@x11
@repos
mtools
pax
oddjob
squashfs-tools
sgpio
genisoimage
wodim
tigervnc-server
certmonger
pam_krb5
krb5-workstation
nscd
pam_ldap
nss-pam-ldapd
gnome-pilot
evolution-exchange
libXmu
SL_desktop_tweaks

# DISA STIG (V-756)
SL_password_for_singleuser

lftp
mysql-connector-java
perl-DBD-MySQL
nmap
wireshark
rdesktop
aide
openscap
epel-release
bash-completion

%end


